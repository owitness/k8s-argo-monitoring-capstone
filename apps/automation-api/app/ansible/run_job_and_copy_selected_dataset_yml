---
- name: Run job and copy contents of a selected output dataset to a local file
  hosts: zos
  gather_facts: no
  collections:
    - ibm.ibm_zos_core
  environment: "{{ environment_vars }}"
   
  tasks:
    - include_tasks: tasks/submit_jcl.yml 
      vars:
        src: IBMUSER.JCL(IN2OUT)
        acceptable_cond_code: 4
         
    - name: Set facts used in this playbook 
      set_fact:
        ddname_to_copy: SYSUT2
        dirname: data
        filename: sysut2.txt
         
    - name: Create destination directory unless it already exists
      include_tasks: tasks/create_directory.yml
       
    - name: Copy lines from dataset SYSUT2 to local file 
      include_tasks: tasks/copy_dataset_to_local_file.yml
      vars:
        pathname: "{{ dirname }}/{{ filename }}"   
        dataset_to_copy: "{{ job_output.jobs[0].ddnames | selectattr('ddname','equalto',ddname_to_copy) | list | first }}"